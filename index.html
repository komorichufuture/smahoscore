<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒãƒ›ç‰ˆ ä½œæ›²ã‚¢ãƒ—ãƒªï¼ˆä»˜ç‚¹ & ã‚¿ã‚¤ & MusicXMLå¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <!-- OSMD CDN -->
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.8/build/opensheetmusicdisplay.min.js"></script>
  <!-- Tone.js for playback -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --app-height: 100vh;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      overflow: hidden;
      height: var(--app-height);
    }

    .app {
      width: 100vw;
      height: var(--app-height);
      display: flex;
      flex-direction: column;
      background: #020617;
    }

    /* ç¸¦å‘ãè­¦å‘Š */
    .rotate-warning {
      display: none;
      position: fixed;
      inset: 0;
      background: #020617;
      color: #e5e7eb;
      z-index: 9999;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 24px;
      font-size: 1.2rem;
    }

    @media screen and (orientation: portrait) {
      .rotate-warning {
        display: flex;
      }
      .app {
        display: none;
      }
    }

    .header-bar {
      flex: 0 0 auto;
      padding: 6px 10px;
      border-bottom: 1px solid #1e293b;
      display: flex;
      align-items: center;
      gap: 6px;
      background: #020617;
      font-size: 0.8rem;
      white-space: nowrap;
      overflow-x: auto;
    }

    .header-bar label {
      opacity: 0.8;
      margin-right: 2px;
    }

    .header-select,
    .header-toggle {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .header-toggle.active {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf866;
    }

    .header-toggle.playing {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .score-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 6px 4px 4px 4px;
      background: #0b1120;
    }

    #osmd-container {
      background: #ffffff;
      border-radius: 8px;
      padding: 8px 4px;
      min-height: 120px;
    }

    #osmd-container svg {
      width: 100%;
      height: auto;
      pointer-events: auto;
    }

    .status-bar {
      flex: 0 0 auto;
      padding: 4px 10px;
      font-size: 0.75rem;
      border-top: 1px solid #1e293b;
      border-bottom: 1px solid #1e293b;
      background: #020617;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      white-space: nowrap;
      overflow-x: auto;
    }

    .status-label {
      opacity: 0.8;
    }

    .status-value {
      font-weight: 600;
      color: #38bdf8;
    }

    .controls {
      flex: 0 0 auto;
      padding: 4px 4px 6px 4px;
      background: #020617;
      border-top: 1px solid #1e293b;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .control-row {
      display: flex;
      gap: 4px;
      justify-content: center;
    }

    .btn {
      flex: 1;
      min-width: 0;
      padding: 6px 4px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 0.85rem;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .btn.small {
      font-size: 0.75rem;
      padding: 4px 2px;
    }

    .btn.tiny {
      font-size: 0.7rem;
      padding: 3px 2px;
    }

    .btn.active {
      background: #38bdf8;
      color: #020617;
      border-color: #38bdf8;
    }

    .btn.accent {
      border-color: #f97316;
      color: #fed7aa;
    }

    .btn.danger {
      border-color: #f97373;
      color: #fecaca;
    }

    .btn:active {
      transform: translateY(1px);
      filter: brightness(1.1);
    }

    @media (max-width: 800px) {
      .btn {
        font-size: 0.8rem;
      }
      .btn.tiny {
        font-size: 0.7rem;
      }
      .header-bar {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="rotate-warning">
    ğŸ“± ã“ã®ä½œæ›²ã‚¢ãƒ—ãƒªã¯æ¨ªç”»é¢ç”¨ã§ã™ã€‚<br><br>
    ã‚¹ãƒãƒ›ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„ã€‚
  </div>

  <div class="app">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒˆéŸ³/ãƒ˜éŸ³ãƒ»æ‹å­ãƒ»èª¿ãƒ»ãƒ†ãƒ³ãƒãƒ»MusicXMLãƒ»å†ç”Ÿ -->
    <div class="header-bar">
      <button id="clef-treble" class="header-toggle active">ãƒˆéŸ³</button>
      <button id="clef-bass" class="header-toggle">ãƒ˜éŸ³</button>

      <div>
        <label for="time-signature">æ‹å­</label>
        <select id="time-signature" class="header-select">
          <option value="4/4">4/4</option>
          <option value="3/4">3/4</option>
          <option value="2/4">2/4</option>
          <option value="6/8">6/8</option>
        </select>
      </div>

      <div>
        <label for="key-signature">èª¿</label>
        <select id="key-signature" class="header-select">
          <option value="0">Cï¼ˆâ™®0ï¼‰</option>
          <option value="1">Gï¼ˆâ™¯1ï¼‰</option>
          <option value="2">Dï¼ˆâ™¯2ï¼‰</option>
          <option value="3">Aï¼ˆâ™¯3ï¼‰</option>
          <option value="4">Eï¼ˆâ™¯4ï¼‰</option>
          <option value="5">Bï¼ˆâ™¯5ï¼‰</option>
          <option value="-1">Fï¼ˆâ™­1ï¼‰</option>
          <option value="-2">Bâ™­ï¼ˆâ™­2ï¼‰</option>
          <option value="-3">Eâ™­ï¼ˆâ™­3ï¼‰</option>
        </select>
      </div>

      <div>
        <label for="tempo">â™©=</label>
        <select id="tempo" class="header-select">
          <option value="60">60</option>
          <option value="80">80</option>
          <option value="100">100</option>
          <option value="120" selected>120</option>
          <option value="140">140</option>
        </select>
      </div>

      <button id="btn-import" class="header-toggle">ğŸ“¤ èª­è¾¼</button>
      <button id="btn-export" class="header-toggle">ğŸ“¥ ä¿å­˜</button>
      <button id="btn-play" class="header-toggle">â–¶ å†ç”Ÿ</button>

      <input type="file" id="musicxml-input"
             accept=".musicxml,.xml,application/xml"
             style="display:none" />
    </div>

    <!-- æ¥½è­œè¡¨ç¤º -->
    <div class="score-container">
      <div id="osmd-container"></div>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="status-bar">
      <div>
        <span class="status-label">ç¾åœ¨ã®éŸ³ï¼š</span>
        <span id="status-pitch" class="status-value">C4</span>
      </div>
      <div>
        <span class="status-label">éŸ³ä¾¡ï¼š</span>
        <span id="status-duration" class="status-value">quarter (â™©)</span>
      </div>
      <div>
        <span class="status-label">ã‚¤ãƒ™ãƒ³ãƒˆæ•°ï¼š</span>
        <span id="status-count" class="status-value">0</span>
      </div>
      <div>
        <span class="status-label">æœ€å¾Œï¼š</span>
        <span id="status-selected" class="status-value">ãªã—</span>
      </div>
    </div>

    <!-- æ“ä½œãƒ‘ãƒãƒ« -->
    <div class="controls">
      <!-- è¡Œ1ï¼šéŸ³åï¼‹è‡¨æ™‚è¨˜å·ï¼‹ä¼‘ç¬¦ -->
      <div class="control-row">
        <button class="btn note-name-btn active" data-step="C">C</button>
        <button class="btn note-name-btn" data-step="D">D</button>
        <button class="btn note-name-btn" data-step="E">E</button>
        <button class="btn note-name-btn" data-step="F">F</button>
        <button class="btn note-name-btn" data-step="G">G</button>
        <button class="btn note-name-btn" data-step="A">A</button>
        <button class="btn note-name-btn" data-step="B">B</button>
        <button class="btn note-acc-btn" data-acc="sharp">#</button>
        <button class="btn note-acc-btn" data-acc="flat">â™­</button>
        <button class="btn note-acc-btn active" data-acc="natural">â™®</button>
        <button class="btn accent" id="btn-rest">ä¼‘ç¬¦</button>
      </div>

      <!-- è¡Œ2ï¼šã‚ªã‚¯ã‚¿ãƒ¼ãƒ– + ä»˜ç‚¹ + ã‚¿ã‚¤ -->
      <div class="control-row">
        <button class="btn octave-btn" data-oct="1">1</button>
        <button class="btn octave-btn" data-oct="2">2</button>
        <button class="btn octave-btn" data-oct="3">3</button>
        <button class="btn octave-btn active" data-oct="4">4</button>
        <button class="btn octave-btn" data-oct="5">5</button>
        <button class="btn octave-btn" data-oct="6">6</button>
        <button class="btn octave-btn" data-oct="7">7</button>
        <button class="btn small" id="btn-dot">ä»˜ç‚¹</button>
        <button class="btn small" id="btn-tie">ã‚¿ã‚¤</button>
      </div>

      <!-- è¡Œ3ï¼šéŸ³ä¾¡ï¼‹å’ŒéŸ³ï¼‹å‰Šé™¤/Undo -->
      <div class="control-row">
        <button class="btn small duration-btn" data-type="whole" data-symbol="ğ…">ğ…</button>
        <button class="btn small duration-btn" data-type="half" data-symbol="ğ…">ğ…</button>
        <button class="btn small duration-btn active" data-type="quarter" data-symbol="â™©">â™©</button>
        <button class="btn small duration-btn" data-type="eighth" data-symbol="â™ª">â™ª</button>
        <button class="btn small duration-btn" data-type="16th" data-symbol="ğ…Ÿ">ğ…Ÿ</button>

        <button class="btn small accent" id="btn-octave-up">+8</button>
        <button class="btn small accent" id="btn-octave-down">-8</button>
        <button class="btn small" id="btn-chord">å’ŒéŸ³</button>
        <button class="btn small danger" id="btn-delete">Del</button>
        <button class="btn small" id="btn-undo">Undo</button>
      </div>
    </div>
  </div>

  <script>
    // ç”»é¢é«˜ã•èª¿æ•´
    function setAppHeight() {
      document.documentElement.style.setProperty(
        "--app-height",
        window.innerHeight + "px"
      );
    }
    window.addEventListener("resize", setAppHeight);
    window.addEventListener("orientationchange", setAppHeight);
    setAppHeight();

    // OSMD & Tone.js
    let osmd = null;
    let synth = null;
    let isPlaying = false;

    // ç¾åœ¨ã®è¨­å®š
    let currentStep = "C";
    let currentAcc = "natural"; // natural | sharp | flat
    let currentOctave = 4;
    let currentDuration = "quarter"; // whole | half | quarter | eighth | 16th
    let chordMode = false;
    let restMode = false;
    let isDotted = false;
    let tieMode = false; // true ã®ã¨ãã€Œç›´å‰ã®éŸ³ã‹ã‚‰ä»Šã®éŸ³ã¸ã‚¿ã‚¤ã€

    // ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—
    // ev: {
    //   durationType: "quarter",
    //   isRest: boolean,
    //   isDotted: boolean,
    //   tiedToNext: boolean,
    //   chords: [{step, alter, octave}]
    // }
    let events = [];
    let history = [];
    let selectedEventIndex = -1;

    function saveHistory() {
      history.push(JSON.parse(JSON.stringify(events)));
      if (history.length > 50) history.shift();
    }

    function restoreHistory() {
      if (history.length === 0) return;
      events = history.pop();
      selectedEventIndex = events.length - 1;
      renderScore();
    }

    function getAccAlterFromCurrent() {
      if (currentAcc === "sharp") return 1;
      if (currentAcc === "flat") return -1;
      return 0;
    }

    function durationToXml(durationType, dotted) {
      let base;
      switch (durationType) {
        case "whole":   base = { duration: 16, type: "whole",   beats: 4 }; break;
        case "half":    base = { duration: 8,  type: "half",    beats: 2 }; break;
        case "quarter": base = { duration: 4,  type: "quarter", beats: 1 }; break;
        case "eighth":  base = { duration: 2,  type: "eighth",  beats: 0.5 }; break;
        case "16th":    base = { duration: 1,  type: "16th",    beats: 0.25 }; break;
        default:        base = { duration: 4,  type: "quarter", beats: 1 }; break;
      }
      if (dotted) {
        base.duration = base.duration * 1.5;
        base.beats = base.beats * 1.5;
      }
      return base;
    }

    function getTimeSignatureValues() {
      const timeValue = document.getElementById("time-signature").value || "4/4";
      const [beats, beatType] = timeValue.split("/").map(v => parseInt(v, 10));
      const measureBeats = beats * (4 / beatType); // 6/8 â†’ 3æ‹æ‰±ã„
      return { beats, beatType, measureBeats };
    }

    function buildMusicXML() {
      const { beats, beatType, measureBeats } = getTimeSignatureValues();
      const keyVal = parseInt(document.getElementById("key-signature").value || "0", 10);

      const clefTrebleActive = document.getElementById("clef-treble").classList.contains("active");
      const clefSign = clefTrebleActive ? "G" : "F";
      const clefLine = clefTrebleActive ? 2 : 4;

      const divisions = 4;

      const measureXmlList = [];
      let currentMeasureNotes = [];
      let currentBeatSum = 0;
      let measureIndex = 1;

      for (let i = 0; i < events.length; i++) {
        const ev = events[i];
        const { duration, type, beats: evBeats } = durationToXml(ev.durationType, ev.isDotted);
        const beatLen = evBeats;

        if (currentBeatSum + beatLen > measureBeats + 1e-6 && currentMeasureNotes.length > 0) {
          const isFirstMeasure = measureIndex === 1;
          const measureXml = createMeasureXml(
            measureIndex,
            currentMeasureNotes.join("\n"),
            isFirstMeasure,
            divisions,
            keyVal,
            beats,
            beatType,
            clefSign,
            clefLine
          );
          measureXmlList.push(measureXml);
          measureIndex++;
          currentMeasureNotes = [];
          currentBeatSum = 0;
        }

        const noteGroupXml = buildEventNotesXml(ev, duration, type, i);
        currentMeasureNotes.push(noteGroupXml);
        currentBeatSum += beatLen;
      }

      if (currentMeasureNotes.length > 0) {
        const isFirstMeasure = measureIndex === 1;
        const measureXml = createMeasureXml(
          measureIndex,
          currentMeasureNotes.join("\n"),
          isFirstMeasure,
          divisions,
          keyVal,
          beats,
          beatType,
          clefSign,
          clefLine
        );
        measureXmlList.push(measureXml);
      }

      const measuresXml = measureXmlList.join("\n");

      const xml = `<?xml version="1.0" encoding="UTF-8"?>
<score-partwise version="3.0">
  <part-list>
    <score-part id="P1">
      <part-name>Music</part-name>
    </score-part>
  </part-list>
  <part id="P1">
${measuresXml || `
    <measure number="1">
      <attributes>
        <divisions>${divisions}</divisions>
        <key><fifths>${keyVal}</fifths></key>
        <time><beats>${beats}</beats><beat-type>${beatType}</beat-type></time>
        <clef><sign>${clefSign}</sign><line>${clefLine}</line></clef>
      </attributes>
    </measure>`}
  </part>
</score-partwise>`;
      return xml;
    }

    function createMeasureXml(
      number,
      notesXml,
      isFirst,
      divisions,
      keyVal,
      beats,
      beatType,
      clefSign,
      clefLine
    ) {
      if (isFirst) {
        return `    <measure number="${number}">
      <attributes>
        <divisions>${divisions}</divisions>
        <key><fifths>${keyVal}</fifths></key>
        <time><beats>${beats}</beats><beat-type>${beatType}</beat-type></time>
        <clef><sign>${clefSign}</sign><line>${clefLine}</line></clef>
      </attributes>
${notesXml}
    </measure>`;
      } else {
        return `    <measure number="${number}">
${notesXml}
    </measure>`;
      }
    }

    // â˜… ã‚¿ã‚¤ã‚’ OSMD ãŒç†è§£ã§ãã‚‹ <notations><tied> ã«å¤‰æ›
    function buildEventNotesXml(ev, duration, type, eventIndex) {
      // ä¼‘ç¬¦
      if (ev.isRest || !ev.chords || ev.chords.length === 0) {
        const dotTag = ev.isDotted ? `<dot/>` : "";
        return `
      <note>
        <rest/>
        <duration>${duration}</duration>
        <voice>1</voice>
        <type>${type}</type>
        ${dotTag}
      </note>`;
      }

      const prevEv = events[eventIndex - 1];
      const hasTieStop = !!(prevEv && prevEv.tiedToNext);
      const hasTieStart = !!ev.tiedToNext;
      const dotTag = ev.isDotted ? `<dot/>` : "";

      let notationsInner = "";
      if (hasTieStop) {
        notationsInner += `<tied type="stop"/>`;
      }
      if (hasTieStart) {
        notationsInner += `<tied type="start"/>`;
      }
      const notationsTag = notationsInner
        ? `<notations>${notationsInner}</notations>`
        : "";

      return ev.chords
        .map((ch, idx) => {
          const alterTag =
            ch.alter !== 0 ? `<alter>${ch.alter}</alter>` : "";
          const accidentalTag =
            ch.alter === 1 ? `<accidental>sharp</accidental>` :
            ch.alter === -1 ? `<accidental>flat</accidental>` : "";
          const chordTag = idx > 0 ? `<chord/>` : "";

          return `
      <note>
        ${chordTag}
        <pitch>
          <step>${ch.step}</step>
          ${alterTag}
          <octave>${ch.octave}</octave>
        </pitch>
        <duration>${duration}</duration>
        <voice>1</voice>
        <type>${type}</type>
        ${dotTag}
        ${accidentalTag}
        ${notationsTag}
      </note>`;
        })
        .join("\n");
    }

    async function renderScore() {
      if (!osmd) return;
      const xml = buildMusicXML();
      try {
        await osmd.load(xml);
        osmd.render();
      } catch (e) {
        console.error("OSMD render error:", e);
      }
      updateStatus();
    }

    function updateStatus() {
      const accSymbol =
        currentAcc === "sharp" ? "#" :
        currentAcc === "flat" ? "b" : "";
      const pitchStr = restMode ? "ä¼‘ç¬¦" : `${currentStep}${accSymbol}${currentOctave}`;
      document.getElementById("status-pitch").textContent = pitchStr;

      const durationLabelMap = {
        whole: "whole (ğ…)",
        half: "half (ğ…)",
        quarter: "quarter (â™©)",
        eighth: "eighth (â™ª)",
        "16th": "16th (ğ…Ÿ)"
      };
      let durText = durationLabelMap[currentDuration] || currentDuration;
      if (isDotted) durText += "ãƒ»";
      document.getElementById("status-duration").textContent = durText;

      document.getElementById("status-count").textContent = String(events.length);

      const selEl = document.getElementById("status-selected");
      if (selectedEventIndex < 0 || selectedEventIndex >= events.length) {
        selEl.textContent = "ãªã—";
      } else {
        const ev = events[selectedEventIndex];
        if (ev.isRest) {
          selEl.textContent = `${selectedEventIndex + 1}ç•ªç›®: ä¼‘ç¬¦`;
        } else {
          const main = ev.chords[0];
          const acc = main.alter === 1 ? "#" : main.alter === -1 ? "b" : "";
          selEl.textContent = `${selectedEventIndex + 1}ç•ªç›®: ${main.step}${acc}${main.octave}`;
        }
      }

      document.getElementById("btn-chord").classList.toggle("active", chordMode);
      document.getElementById("btn-rest").classList.toggle("active", restMode);
      document.getElementById("btn-dot").classList.toggle("active", isDotted);
      document.getElementById("btn-tie").classList.toggle("active", tieMode);
    }

    // â˜… ã“ã“ãŒã‚¿ã‚¤æŒ™å‹•ã‚’ç›´ã—ãŸ addEventOrChord
    function addEventOrChord() {
      // ä¼‘ç¬¦ãƒ¢ãƒ¼ãƒ‰ â†’ å¸¸ã«æ–°ã—ã„ä¼‘ç¬¦ã‚¤ãƒ™ãƒ³ãƒˆ
      if (restMode) {
        saveHistory();
        events.push({
          durationType: currentDuration,
          isRest: true,
          isDotted: isDotted,
          tiedToNext: false,
          chords: []
        });
        selectedEventIndex = events.length - 1;
        renderScore();
        return;
      }

      // å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰ï¼šç›´å‰ã‚¤ãƒ™ãƒ³ãƒˆã«ç©ã‚€ï¼ˆç›´å‰ãŒä¼‘ç¬¦ãªã‚‰æ–°è¦ï¼‰
      if (chordMode && events.length > 0) {
        saveHistory();
        const lastEv = events[events.length - 1];

        if (lastEv.isRest) {
          const newEv = {
            durationType: currentDuration,
            isRest: false,
            isDotted: isDotted,
            tiedToNext: false,
            chords: [{
              step: currentStep,
              alter: getAccAlterFromCurrent(),
              octave: currentOctave
            }]
          };
          events.push(newEv);
          selectedEventIndex = events.length - 1;
        } else {
          lastEv.chords.push({
            step: currentStep,
            alter: getAccAlterFromCurrent(),
            octave: currentOctave
          });
          selectedEventIndex = events.length - 1;
        }

        renderScore();
        return;
      }

      // é€šå¸¸ï¼šå˜éŸ³ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
      saveHistory();

      // ã‚¿ã‚¤ãƒ¢ãƒ¼ãƒ‰ãŒ ON ãªã‚‰ã€Œç›´å‰ã®éŸ³ç¬¦ã€ã‹ã‚‰ä»Šå›ã®éŸ³ã¸ã‚¿ã‚¤ã‚’å¼µã‚‹
      if (tieMode && events.length > 0) {
        const prevEv = events[events.length - 1];
        if (!prevEv.isRest) {
          prevEv.tiedToNext = true;
        }
      }

      const newEvent = {
        durationType: currentDuration,
        isRest: false,
        isDotted: isDotted,
        tiedToNext: false,
        chords: [{
          step: currentStep,
          alter: getAccAlterFromCurrent(),
          octave: currentOctave
        }]
      };

      events.push(newEvent);
      selectedEventIndex = events.length - 1;
      renderScore();
    }

    function deleteLastEvent() {
      if (events.length === 0) return;
      saveHistory();
      events.pop();
      selectedEventIndex = events.length - 1;
      renderScore();
    }

    function changeOctave(delta) {
      let newOct = currentOctave + delta;
      if (newOct < 1) newOct = 1;
      if (newOct > 7) newOct = 7;
      currentOctave = newOct;
      document.querySelectorAll(".octave-btn").forEach(btn => {
        btn.classList.toggle("active", parseInt(btn.dataset.oct, 10) === currentOctave);
      });
      updateStatus();
    }

    // â˜… MusicXML ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportMusicXML() {
      const xml = buildMusicXML();
      const blob = new Blob([xml], { type: "application/vnd.recordare.musicxml+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
      a.download = `score_${timestamp}.musicxml`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // â˜… MusicXML ã‚¤ãƒ³ãƒãƒ¼ãƒˆ â†’ events[] å†æ§‹ç¯‰
    function importMusicXMLFromText(xmlText) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, "application/xml");

      const part = xmlDoc.querySelector("score-partwise > part");
      if (!part) {
        alert("èª­ã¿è¾¼ã‚ã‚‹ãƒ‘ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        return;
      }

      // 1) attributes ã‹ã‚‰æ‹å­ãƒ»èª¿ãƒ»è¨˜å·ãƒ»ãƒ†ãƒ³ãƒã‚’åæ˜ 
      const firstMeasure = part.querySelector("measure");
      if (firstMeasure) {
        const time = firstMeasure.querySelector("attributes > time");
        if (time) {
          const beats = time.querySelector("beats")?.textContent?.trim();
          const beatType = time.querySelector("beat-type")?.textContent?.trim();
          if (beats && beatType) {
            const tsValue = `${beats}/${beatType}`;
            const tsSelect = document.getElementById("time-signature");
            const exists = Array.from(tsSelect.options).some(o => o.value === tsValue);
            if (exists) tsSelect.value = tsValue;
          }
        }

        const key = firstMeasure.querySelector("attributes > key > fifths");
        if (key) {
          const val = key.textContent.trim();
          const ks = document.getElementById("key-signature");
          const exists = Array.from(ks.options).some(o => o.value === val);
          if (exists) ks.value = val;
        }

        const clefSignEl = firstMeasure.querySelector("attributes > clef > sign");
        if (clefSignEl) {
          const sign = clefSignEl.textContent.trim();
          const trebleBtn = document.getElementById("clef-treble");
          const bassBtn = document.getElementById("clef-bass");
          if (sign === "F") {
            bassBtn.classList.add("active");
            trebleBtn.classList.remove("active");
          } else {
            trebleBtn.classList.add("active");
            bassBtn.classList.remove("active");
          }
        }
      }

      const sound = xmlDoc.querySelector("sound[tempo]");
      if (sound) {
        const tempo = sound.getAttribute("tempo");
        const tempoSelect = document.getElementById("tempo");
        if (tempo && Array.from(tempoSelect.options).some(o => o.value === tempo)) {
          tempoSelect.value = tempo;
        }
      }

      // 2) notes â†’ events[] ã«å¤‰æ›ï¼ˆå’ŒéŸ³ãƒ»ä¼‘ç¬¦ãƒ»ä»˜ç‚¹ãƒ»ã‚¿ã‚¤å¯¾å¿œã®ç°¡æ˜“ç‰ˆï¼‰
      events = [];
      history = [];
      selectedEventIndex = -1;

      let currentEvent = null;

      const noteNodes = part.querySelectorAll("measure > note");
      noteNodes.forEach(note => {
        const isChord = !!note.querySelector("chord");
        const isRest = !!note.querySelector("rest");

        const typeEl = note.querySelector("type");
        const typeText = typeEl ? typeEl.textContent.trim() : "quarter";
        const map = {
          "whole": "whole",
          "half": "half",
          "quarter": "quarter",
          "eighth": "eighth",
          "16th": "16th",
          "32nd": "16th" // 32åˆ†éŸ³ç¬¦ã¯ã¨ã‚Šã‚ãˆãš16åˆ†æ‰±ã„
        };
        const durationType = map[typeText] || "quarter";

        const dotted = note.querySelectorAll("dot").length > 0;

        // tie start åˆ¤å®šï¼ˆ<tie> ã¨ <notations><tied> ä¸¡æ–¹ã‚’è¦‹ã‚‹ï¼‰
        let tiedStart = false;
        note.querySelectorAll("tie").forEach(t => {
          if (t.getAttribute("type") === "start") tiedStart = true;
        });
        note.querySelectorAll("notations > tied").forEach(t => {
          if (t.getAttribute("type") === "start") tiedStart = true;
        });

        if (!isChord) {
          // å‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®š
          if (currentEvent) events.push(currentEvent);

          currentEvent = {
            durationType,
            isRest,
            isDotted: dotted,
            tiedToNext: tiedStart,
            chords: []
          };
        } else {
          // chord ã®å ´åˆã¯ç›´å‰ã‚¤ãƒ™ãƒ³ãƒˆã«ç©ã‚€ï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
          if (!currentEvent) {
            currentEvent = {
              durationType,
              isRest,
              isDotted: dotted,
              tiedToNext: tiedStart,
              chords: []
            };
          } else {
            // chord ãƒãƒ¼ãƒˆã«ã ã‘ tie start ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚‹ã®ã§ä¸Šæ›¸ã
            if (tiedStart) currentEvent.tiedToNext = true;
          }
        }

        if (!isRest) {
          const stepEl = note.querySelector("pitch > step");
          const octaveEl = note.querySelector("pitch > octave");
          const alterEl = note.querySelector("pitch > alter");

          const step = stepEl ? stepEl.textContent.trim() : "C";
          const octave = octaveEl ? parseInt(octaveEl.textContent.trim(), 10) || 4 : 4;
          const alter = alterEl ? parseInt(alterEl.textContent.trim(), 10) || 0 : 0;

          currentEvent.chords.push({ step, alter, octave });
        }
      });

      if (currentEvent) events.push(currentEvent);
      selectedEventIndex = events.length - 1;

      renderScore();
    }

    async function playScore() {
      if (isPlaying) {
        // åœæ­¢
        Tone.Transport.stop();
        Tone.Transport.cancel();
        isPlaying = false;
        const b = document.getElementById("btn-play");
        b.classList.remove("playing");
        b.textContent = "â–¶ å†ç”Ÿ";
        return;
      }

      if (!synth) {
        await Tone.start();
        synth = new Tone.PolySynth(Tone.Synth).toDestination();
      }

      Tone.Transport.stop();
      Tone.Transport.cancel();

      const tempo = parseInt(document.getElementById("tempo").value || "120", 10);
      Tone.Transport.bpm.value = tempo;

      let currentBeat = 0;

      let i = 0;
      while (i < events.length) {
        const ev = events[i];
        let { beats } = durationToXml(ev.durationType, ev.isDotted);
        let totalBeats = beats;

        // ã‚¿ã‚¤ã§ã¤ãªãŒã£ã¦ã„ã‚‹é€£ç¶šã‚¤ãƒ™ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã‚‹
        let j = i;
        while (events[j] && events[j].tiedToNext && events[j + 1]) {
          const nextEv = events[j + 1];
          const nextDur = durationToXml(nextEv.durationType, nextEv.isDotted);
          totalBeats += nextDur.beats;
          j++;
        }

        if (!ev.isRest && ev.chords && ev.chords.length > 0) {
          const notes = ev.chords.map(ch => {
            const acc =
              ch.alter === 1 ? "#" :
              ch.alter === -1 ? "b" : "";
            return `${ch.step}${acc}${ch.octave}`;
          });

          const startTime = `${currentBeat} * 4n`;
          const durBeats = totalBeats;
          synth.triggerAttackRelease(
            notes,
            `${durBeats} * 4n`,
            Tone.Time(startTime)
          );
        }

        currentBeat += totalBeats;
        i = j + 1;
      }

      const totalSeconds = Tone.Time(`${currentBeat} * 4n`).toSeconds();
      setTimeout(() => {
        isPlaying = false;
        const btn = document.getElementById("btn-play");
        btn.classList.remove("playing");
        btn.textContent = "â–¶ å†ç”Ÿ";
      }, totalSeconds * 1000 + 200);

      isPlaying = true;
      const btn = document.getElementById("btn-play");
      btn.classList.add("playing");
      btn.textContent = "â–  åœæ­¢";
      Tone.Transport.start();
    }

    window.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("osmd-container");
      osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(container, {
        autoResize: true,
        drawPartNames: false,
        drawMeasureNumbers: false,
        drawTitle: false,
        backend: "svg",
      });

      renderScore();

      // æ¥½è­œã‚¯ãƒªãƒƒã‚¯ï¼šSVGä¸Šã ã‘åå¿œ
      container.addEventListener("click", (e) => {
        const svg = container.querySelector("svg");
        if (svg && svg.contains(e.target)) {
          addEventOrChord();
        }
      });

      // éŸ³å
      document.querySelectorAll(".note-name-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".note-name-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentStep = btn.dataset.step;
          restMode = false;
          updateStatus();
        });
      });

      // è‡¨æ™‚è¨˜å·
      document.querySelectorAll(".note-acc-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".note-acc-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentAcc = btn.dataset.acc;
          restMode = false;
          updateStatus();
        });
      });

      // ä¼‘ç¬¦ãƒ¢ãƒ¼ãƒ‰
      document.getElementById("btn-rest").addEventListener("click", (e) => {
        e.stopPropagation();
        restMode = !restMode;
        if (restMode) {
          chordMode = false;
        }
        updateStatus();
      });

      // ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–
      document.querySelectorAll(".octave-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".octave-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentOctave = parseInt(btn.dataset.oct, 10);
          updateStatus();
        });
      });

      // éŸ³ä¾¡
      document.querySelectorAll(".duration-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".duration-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentDuration = btn.dataset.type;
          updateStatus();
        });
      });

      // ä»˜ç‚¹
      document.getElementById("btn-dot").addEventListener("click", (e) => {
        e.stopPropagation();
        isDotted = !isDotted;
        updateStatus();
      });

      // ã‚¿ã‚¤ãƒ¢ãƒ¼ãƒ‰
      document.getElementById("btn-tie").addEventListener("click", (e) => {
        e.stopPropagation();
        tieMode = !tieMode;
        updateStatus();
      });

      // å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰
      document.getElementById("btn-chord").addEventListener("click", (e) => {
        e.stopPropagation();
        chordMode = !chordMode;
        if (chordMode) {
          restMode = false;
        }
        updateStatus();
      });

      // ã‚ªã‚¯ã‚¿ãƒ¼ãƒ– Â±
      document.getElementById("btn-octave-up").addEventListener("click", (e) => {
        e.stopPropagation();
        changeOctave(1);
      });
      document.getElementById("btn-octave-down").addEventListener("click", (e) => {
        e.stopPropagation();
        changeOctave(-1);
      });

      // å‰Šé™¤ãƒ»Undo
      document.getElementById("btn-delete").addEventListener("click", (e) => {
        e.stopPropagation();
        deleteLastEvent();
      });
      document.getElementById("btn-undo").addEventListener("click", (e) => {
        e.stopPropagation();
        restoreHistory();
      });

      // ãƒˆéŸ³/ãƒ˜éŸ³
      const trebleBtn = document.getElementById("clef-treble");
      const bassBtn = document.getElementById("clef-bass");
      trebleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        trebleBtn.classList.add("active");
        bassBtn.classList.remove("active");
        renderScore();
      });
      bassBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        bassBtn.classList.add("active");
        trebleBtn.classList.remove("active");
        renderScore();
      });

      // æ‹å­ãƒ»èª¿å¤‰æ›´
      document.getElementById("time-signature").addEventListener("change", renderScore);
      document.getElementById("key-signature").addEventListener("change", renderScore);

      // MusicXML èª­ã¿è¾¼ã¿
      const fileInput = document.getElementById("musicxml-input");
      document.getElementById("btn-import").addEventListener("click", (e) => {
        e.stopPropagation();
        fileInput.click();
      });
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const text = ev.target.result;
          try {
            importMusicXMLFromText(text);
          } catch (err) {
            console.error(err);
            alert("MusicXMLã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        };
        reader.readAsText(file);
        // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶šã‘ã¦èª­ã‚ã‚‹ã‚ˆã†ã«ã‚¯ãƒªã‚¢
        e.target.value = "";
      });

      // MusicXML ä¿å­˜
      document.getElementById("btn-export").addEventListener("click", (e) => {
        e.stopPropagation();
        exportMusicXML();
      });

      // å†ç”Ÿ
      document.getElementById("btn-play").addEventListener("click", (e) => {
        e.stopPropagation();
        playScore();
      });

      updateStatus();
    });
  </script>
</body>
</html>
