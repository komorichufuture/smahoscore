<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒãƒ›ç‰ˆ ä½œæ›²ã‚¢ãƒ—ãƒª Proï¼ˆä¼‘ç¬¦ãƒ»ã‚¹ãƒ©ãƒ¼ãƒ»ã‚¿ã‚¤å¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <!-- OSMD CDN -->
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.8/build/opensheetmusicdisplay.min.js"></script>
  <!-- Tone.js for playback -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --app-height: 100vh;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      overflow: hidden;
      height: var(--app-height);
    }

    .app {
      width: 100vw;
      height: var(--app-height);
      display: flex;
      flex-direction: column;
      background: #020617;
    }

    /* ç¸¦å‘ãè­¦å‘Š */
    .rotate-warning {
      display: none;
      position: fixed;
      inset: 0;
      background: #020617;
      color: #e5e7eb;
      z-index: 9999;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 24px;
      font-size: 1.2rem;
    }

    @media screen and (orientation: portrait) {
      .rotate-warning {
        display: flex;
      }
      .app {
        display: none;
      }
    }

    .header-bar {
      flex: 0 0 auto;
      padding: 6px 10px;
      border-bottom: 1px solid #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #020617;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow-x: auto;
    }

    .header-bar label {
      opacity: 0.8;
      margin-right: 4px;
    }

    .header-select,
    .header-toggle {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .header-toggle.active {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf866;
    }

    .score-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 6px 4px 4px 4px;
      background: #0b1120;
      position: relative;
    }

    #osmd-container {
      background: white;
      border-radius: 8px;
      padding: 8px 4px;
      min-height: 120px;
    }

    #osmd-container svg {
      width: 100%;
      height: auto;
      pointer-events: auto;
    }

    .status-bar {
      flex: 0 0 auto;
      padding: 4px 10px;
      font-size: 0.75rem;
      border-top: 1px solid #1e293b;
      border-bottom: 1px solid #1e293b;
      background: #020617;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      white-space: nowrap;
      overflow-x: auto;
    }

    .status-label {
      opacity: 0.8;
    }

    .status-value {
      font-weight: 600;
      color: #38bdf8;
    }

    .controls {
      flex: 0 0 auto;
      padding: 4px 4px 6px 4px;
      background: #020617;
      border-top: 1px solid #1e293b;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .control-row {
      display: flex;
      gap: 4px;
      justify-content: center;
    }

    .btn {
      flex: 1;
      min-width: 0;
      padding: 6px 4px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 0.85rem;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .btn.small {
      font-size: 0.75rem;
      padding: 4px 2px;
    }

    .btn.tiny {
      font-size: 0.7rem;
      padding: 3px 2px;
    }

    .btn.active {
      background: #38bdf8;
      color: #020617;
      border-color: #38bdf8;
    }

    .btn.accent {
      border-color: #f97316;
      color: #fed7aa;
    }

    .btn.danger {
      border-color: #f97373;
      color: #fecaca;
    }

    .btn.success {
      border-color: #4ade80;
      color: #bbf7d0;
    }

    .btn:active {
      transform: translateY(1px);
      filter: brightness(1.1);
    }

    .mode-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #38bdf8;
      color: #020617;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 10;
      display: none;
    }

    .mode-indicator.visible {
      display: block;
    }

    /* é¸æŠã•ã‚ŒãŸéŸ³ç¬¦ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .note-selected {
      fill: #38bdf8 !important;
      stroke: #38bdf8 !important;
    }

    @media (max-width: 800px) {
      .btn {
        font-size: 0.75rem;
      }
      .btn.tiny {
        font-size: 0.65rem;
      }
      .header-bar {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="rotate-warning">
    ğŸ“± ã“ã®ä½œæ›²ã‚¢ãƒ—ãƒªã¯æ¨ªç”»é¢ç”¨ã§ã™ã€‚<br><br>
    ã‚¹ãƒãƒ›ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„ã€‚
  </div>

  <div class="app">
    <!-- ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div id="mode-indicator" class="mode-indicator"></div>

    <!-- æ¥½è­œãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header-bar">
      <button id="clef-treble" class="header-toggle active">ãƒˆéŸ³</button>
      <button id="clef-bass" class="header-toggle">ãƒ˜éŸ³</button>

      <div>
        <label for="time-signature">æ‹å­</label>
        <select id="time-signature" class="header-select">
          <option value="4/4">4/4</option>
          <option value="3/4">3/4</option>
          <option value="2/4">2/4</option>
          <option value="6/8">6/8</option>
        </select>
      </div>

      <div>
        <label for="key-signature">èª¿</label>
        <select id="key-signature" class="header-select">
          <option value="0">C</option>
          <option value="1">G</option>
          <option value="2">D</option>
          <option value="3">A</option>
          <option value="4">E</option>
          <option value="5">B</option>
          <option value="-1">F</option>
          <option value="-2">Bâ™­</option>
          <option value="-3">Eâ™­</option>
        </select>
      </div>

      <div>
        <label for="tempo">â™©=</label>
        <select id="tempo" class="header-select">
          <option value="60">60</option>
          <option value="80">80</option>
          <option value="100">100</option>
          <option value="120" selected>120</option>
          <option value="140">140</option>
        </select>
      </div>

      <button id="btn-play" class="header-toggle success">â–¶ å†ç”Ÿ</button>
      <button id="btn-export" class="header-toggle">ğŸ“¥ ä¿å­˜</button>
    </div>

    <!-- æ¥½è­œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="score-container">
      <div id="osmd-container"></div>
    </div>

    <!-- ç¾åœ¨çŠ¶æ…‹è¡¨ç¤º -->
    <div class="status-bar">
      <div>
        <span class="status-label">éŸ³ï¼š</span>
        <span id="status-pitch" class="status-value">C4</span>
      </div>
      <div>
        <span class="status-label">éŸ³ä¾¡ï¼š</span>
        <span id="status-duration" class="status-value">â™©</span>
      </div>
      <div>
        <span class="status-label">éŸ³ç¬¦æ•°ï¼š</span>
        <span id="status-count" class="status-value">0</span>
      </div>
      <div>
        <span class="status-label">é¸æŠï¼š</span>
        <span id="status-selected" class="status-value">ãªã—</span>
      </div>
    </div>

    <!-- æ“ä½œãƒ‘ãƒãƒ«ï¼ˆ4è¡Œï¼‰ -->
    <div class="controls">
      <!-- è¡Œ1ï¼šéŸ³åï¼‹ä¼‘ç¬¦ï¼‹è‡¨æ™‚è¨˜å· -->
      <div class="control-row" id="row-note-names">
        <button class="btn note-name-btn active" data-step="C">C</button>
        <button class="btn note-name-btn" data-step="D">D</button>
        <button class="btn note-name-btn" data-step="E">E</button>
        <button class="btn note-name-btn" data-step="F">F</button>
        <button class="btn note-name-btn" data-step="G">G</button>
        <button class="btn note-name-btn" data-step="A">A</button>
        <button class="btn note-name-btn" data-step="B">B</button>
        <button class="btn btn-rest accent" id="btn-rest">ä¼‘ç¬¦</button>
        <button class="btn note-acc-btn" data-acc="sharp">#</button>
        <button class="btn note-acc-btn" data-acc="flat">â™­</button>
        <button class="btn note-acc-btn active" data-acc="natural">â™®</button>
      </div>

      <!-- è¡Œ2ï¼šã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼‹ä»˜ç‚¹ -->
      <div class="control-row" id="row-octaves">
        <button class="btn octave-btn" data-oct="1">1</button>
        <button class="btn octave-btn" data-oct="2">2</button>
        <button class="btn octave-btn" data-oct="3">3</button>
        <button class="btn octave-btn active" data-oct="4">4</button>
        <button class="btn octave-btn" data-oct="5">5</button>
        <button class="btn octave-btn" data-oct="6">6</button>
        <button class="btn octave-btn" data-oct="7">7</button>
        <button class="btn btn-dot" id="btn-dot">ä»˜ç‚¹</button>
        <button class="btn btn-triplet" id="btn-triplet">3é€£ç¬¦</button>
      </div>

      <!-- è¡Œ3ï¼šéŸ³ä¾¡ -->
      <div class="control-row" id="row-durations">
        <button class="btn duration-btn small" data-type="whole" data-symbol="ğ…">ğ…</button>
        <button class="btn duration-btn small" data-type="half" data-symbol="ğ…—ğ…¥">ğ…—ğ…¥</button>
        <button class="btn duration-btn small active" data-type="quarter" data-symbol="â™©">â™©</button>
        <button class="btn duration-btn small" data-type="eighth" data-symbol="â™ª">â™ª</button>
        <button class="btn duration-btn small" data-type="16th" data-symbol="ğ…˜ğ…¥">ğ…˜ğ…¥</button>
        <button class="btn duration-btn small" data-type="32nd" data-symbol="ğ…˜ğ…¥ğ…¯">ğ…˜ğ…¥ğ…¯</button>
      </div>

      <!-- è¡Œ4ï¼šç·¨é›†æ©Ÿèƒ½ï¼‹è£…é£¾ -->
      <div class="control-row" id="row-tools">
        <button class="btn tiny" id="btn-chord">å’ŒéŸ³</button>
        <button class="btn tiny" id="btn-tie">ã‚¿ã‚¤</button>
        <button class="btn tiny" id="btn-slur">ã‚¹ãƒ©ãƒ¼</button>
        <button class="btn tiny accent" id="btn-staccato">ã‚¹ã‚¿</button>
        <button class="btn tiny accent" id="btn-accent">></button>
        <button class="btn tiny success" id="btn-select">é¸æŠ</button>
        <button class="btn tiny danger" id="btn-delete">å‰Šé™¤</button>
        <button class="btn tiny" id="btn-undo">æˆ»ã‚‹</button>
        <button class="btn tiny" id="btn-clear">å…¨æ¶ˆå»</button>
      </div>
    </div>
  </div>

  <script>
    // ç”»é¢é«˜ã•èª¿æ•´
    function setAppHeight() {
      document.documentElement.style.setProperty(
        "--app-height",
        window.innerHeight + "px"
      );
    }
    window.addEventListener("resize", setAppHeight);
    window.addEventListener("orientationchange", setAppHeight);
    setAppHeight();

    // OSMD ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    let osmd = null;
    let synth = null; // Tone.js ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼

    // ç¾åœ¨ã®è¨­å®š
    let currentStep = "C";
    let currentAcc = "natural";
    let currentOctave = 4;
    let currentDuration = "quarter";
    let isDotted = false;
    let isTriplet = false;
    let isRest = false;
    
    // ãƒ¢ãƒ¼ãƒ‰
    let chordMode = false;
    let tieMode = false;
    let slurMode = false;
    let selectMode = false;
    let slurStartIndex = -1;

    // ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—ï¼ˆæ‹¡å¼µï¼‰
    // event: { 
    //   durationType: "quarter",
    //   isDotted: false,
    //   isTriplet: false,
    //   isRest: false,
    //   chords: [{ step, alter, octave }],
    //   tied: false,  // æ¬¡ã®éŸ³ç¬¦ã¨ã‚¿ã‚¤ã§çµã°ã‚Œã‚‹
    //   slurStart: false, // ã‚¹ãƒ©ãƒ¼é–‹å§‹
    //   slurEnd: false,   // ã‚¹ãƒ©ãƒ¼çµ‚äº†
    //   staccato: false,
    //   accent: false
    // }
    let events = [];
    let history = [];
    let selectedEventIndex = -1;

    function saveHistory() {
      history.push(JSON.parse(JSON.stringify(events)));
      if (history.length > 50) history.shift();
    }

    function restoreHistory() {
      if (history.length === 0) return;
      events = history.pop();
      selectedEventIndex = Math.min(selectedEventIndex, events.length - 1);
      renderScore();
    }

    function getAccAlterFromCurrent() {
      if (currentAcc === "sharp") return 1;
      if (currentAcc === "flat") return -1;
      return 0;
    }

    function durationToXml(durationType, isDotted, isTriplet) {
      let base = {
        "whole":   { duration: 16, type: "whole", beats: 4 },
        "half":    { duration: 8,  type: "half",  beats: 2 },
        "quarter": { duration: 4,  type: "quarter", beats: 1 },
        "eighth":  { duration: 2,  type: "eighth", beats: 0.5 },
        "16th":    { duration: 1,  type: "16th", beats: 0.25 },
        "32nd":    { duration: 0.5, type: "32nd", beats: 0.125 }
      }[durationType] || { duration: 4, type: "quarter", beats: 1 };

      if (isDotted) {
        base.duration = base.duration * 1.5;
        base.beats = base.beats * 1.5;
      }

      if (isTriplet) {
        base.duration = Math.floor(base.duration * 2 / 3);
        base.beats = base.beats * 2 / 3;
      }

      return base;
    }

    function getTimeSignatureValues() {
      const timeValue = document.getElementById("time-signature").value || "4/4";
      const [beats, beatType] = timeValue.split("/").map(v => parseInt(v, 10));
      const measureBeats = beats * (4 / beatType);
      return { beats, beatType, measureBeats };
    }

    function buildMusicXML() {
      const { beats, beatType, measureBeats } = getTimeSignatureValues();
      const keyVal = parseInt(document.getElementById("key-signature").value || "0", 10);
      const tempo = parseInt(document.getElementById("tempo").value || "120", 10);

      const clefTrebleActive = document.getElementById("clef-treble").classList.contains("active");
      const clefSign = clefTrebleActive ? "G" : "F";
      const clefLine = clefTrebleActive ? 2 : 4;

      const divisions = 4;

      if (events.length === 0) {
        return `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <part-list>
    <score-part id="P1">
      <part-name>Music</part-name>
    </score-part>
  </part-list>
  <part id="P1">
    <measure number="1">
      <attributes>
        <divisions>${divisions}</divisions>
        <key><fifths>${keyVal}</fifths></key>
        <time><beats>${beats}</beats><beat-type>${beatType}</beat-type></time>
        <clef><sign>${clefSign}</sign><line>${clefLine}</line></clef>
      </attributes>
      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${tempo}</per-minute>
          </metronome>
        </direction-type>
        <sound tempo="${tempo}"/>
      </direction>
      <note>
        <rest/>
        <duration>${divisions * beats}</duration>
        <voice>1</voice>
        <type>whole</type>
      </note>
    </measure>
  </part>
</score-partwise>`;
      }

      const measureXmlList = [];
      let currentMeasureNotes = [];
      let currentBeatSum = 0;
      let measureIndex = 1;

      for (let i = 0; i < events.length; i++) {
        const ev = events[i];
        const { duration, type, beats: evBeats } = durationToXml(ev.durationType, ev.isDotted, ev.isTriplet);
        const beatLen = evBeats;

        if (currentBeatSum + beatLen > measureBeats + 0.0001 && currentMeasureNotes.length > 0) {
          const isFirstMeasure = measureIndex === 1;
          const measureXml = createMeasureXml(
            measureIndex,
            currentMeasureNotes,
            isFirstMeasure,
            divisions,
            keyVal,
            beats,
            beatType,
            clefSign,
            clefLine,
            tempo
          );
          measureXmlList.push(measureXml);
          measureIndex++;
          currentMeasureNotes = [];
          currentBeatSum = 0;
        }

        const noteGroupXml = buildEventNotesXml(ev, duration, type, i);
        currentMeasureNotes.push(noteGroupXml);
        currentBeatSum += beatLen;
      }

      if (currentMeasureNotes.length > 0) {
        const isFirstMeasure = measureIndex === 1;
        const measureXml = createMeasureXml(
          measureIndex,
          currentMeasureNotes,
          isFirstMeasure,
          divisions,
          keyVal,
          beats,
          beatType,
          clefSign,
          clefLine,
          tempo
        );
        measureXmlList.push(measureXml);
      }

      const measuresXml = measureXmlList.join("\n");

      return `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <part-list>
    <score-part id="P1">
      <part-name>Music</part-name>
    </score-part>
  </part-list>
  <part id="P1">
${measuresXml}
  </part>
</score-partwise>`;
    }

    function createMeasureXml(
      number,
      noteGroups,
      isFirst,
      divisions,
      keyVal,
      beats,
      beatType,
      clefSign,
      clefLine,
      tempo
    ) {
      const notesXml = noteGroups.join("");
      
      if (isFirst) {
        return `    <measure number="${number}">
      <attributes>
        <divisions>${divisions}</divisions>
        <key><fifths>${keyVal}</fifths></key>
        <time><beats>${beats}</beats><beat-type>${beatType}</beat-type></time>
        <clef><sign>${clefSign}</sign><line>${clefLine}</line></clef>
      </attributes>
      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${tempo}</per-minute>
          </metronome>
        </direction-type>
        <sound tempo="${tempo}"/>
      </direction>${notesXml}
    </measure>`;
      } else {
        return `    <measure number="${number}">${notesXml}
    </measure>`;
      }
    }

    function buildEventNotesXml(ev, duration, type, eventIndex) {
      let xml = "";

      // ä¼‘ç¬¦ã®å ´åˆ
      if (ev.isRest) {
        const dotTag = ev.isDotted ? `
        <dot/>` : "";
        const tripletTags = ev.isTriplet ? `
        <time-modification>
          <actual-notes>3</actual-notes>
          <normal-notes>2</normal-notes>
        </time-modification>` : "";

        xml = `
      <note>
        <rest/>
        <duration>${duration}</duration>
        <voice>1</voice>
        <type>${type}</type>${dotTag}${tripletTags}
      </note>`;
        return xml;
      }

      // éŸ³ç¬¦ã®å ´åˆ
      ev.chords.forEach((ch, idx) => {
        const alterTag = (ch.alter !== 0) ? `
        <alter>${ch.alter}</alter>` : "";
        
        const accidentalTag = (ch.alter === 1) ? `
        <accidental>sharp</accidental>` 
          : (ch.alter === -1) ? `
        <accidental>flat</accidental>` : "";
        
        const chordTag = idx > 0 ? `
        <chord/>` : "";

        const dotTag = ev.isDotted ? `
        <dot/>` : "";

        const tieStartTag = ev.tied ? `
        <tie type="start"/>` : "";

        const tieStopTag = (eventIndex > 0 && events[eventIndex - 1].tied) ? `
        <tie type="stop"/>` : "";

        const slurTag = ev.slurStart ? `
        <slur number="1" type="start"/>` : ev.slurEnd ? `
        <slur number="1" type="stop"/>` : "";

        const articulationTag = ev.staccato ? `
        <articulations>
          <staccato/>
        </articulations>` : ev.accent ? `
        <articulations>
          <accent/>
        </articulations>` : "";

        const tripletTags = ev.isTriplet ? `
        <time-modification>
          <actual-notes>3</actual-notes>
          <normal-notes>2</normal-notes>
        </time-modification>` : "";

        const notationsContent = [tieStartTag, tieStopTag, slurTag, articulationTag].filter(Boolean).join("");
        const notationsTag = notationsContent ? `
        <notations>${notationsContent}
        </notations>` : "";

        xml += `
      <note>${chordTag}
        <pitch>
          <step>${ch.step}</step>${alterTag}
          <octave>${ch.octave}</octave>
        </pitch>
        <duration>${duration}</duration>
        <voice>1</voice>
        <type>${type}</type>${dotTag}${accidentalTag}${tripletTags}${notationsTag}
      </note>`;
      });

      return xml;
    }

    async function renderScore() {
      if (!osmd) return;
      
      const xml = buildMusicXML();
      
      try {
        osmd.clear();
        await osmd.load(xml);
        osmd.render();
      } catch (e) {
        console.error("OSMD render error:", e);
      }
      
      updateStatus();
      updateModeIndicator();
    }

    function updateStatus() {
      const accSymbol = currentAcc === "sharp" ? "#" :
                        currentAcc === "flat" ? "b" : "";
      const restText = isRest ? "(ä¼‘ç¬¦)" : "";
      const pitchStr = isRest ? "ä¼‘ç¬¦" : `${currentStep}${accSymbol}${currentOctave}`;
      document.getElementById("status-pitch").textContent = pitchStr;

      const durationSymbols = {
        whole: "ğ…", half: "ğ…—ğ…¥", quarter: "â™©",
        eighth: "â™ª", "16th": "ğ…˜ğ…¥", "32nd": "ğ…˜ğ…¥ğ…¯"
      };
      let durText = durationSymbols[currentDuration] || currentDuration;
      if (isDotted) durText += "ãƒ»";
      if (isTriplet) durText += "Â³";
      document.getElementById("status-duration").textContent = durText;

      document.getElementById("status-count").textContent = String(events.length);

      const selEl = document.getElementById("status-selected");
      if (selectedEventIndex < 0 || selectedEventIndex >= events.length) {
        selEl.textContent = "ãªã—";
      } else {
        const ev = events[selectedEventIndex];
        if (ev.isRest) {
          selEl.textContent = `${selectedEventIndex + 1}ç•ªç›®: ä¼‘ç¬¦`;
        } else {
          const main = ev.chords[0];
          const acc = main.alter === 1 ? "#" : main.alter === -1 ? "b" : "";
          selEl.textContent = `${selectedEventIndex + 1}ç•ªç›®: ${main.step}${acc}${main.octave}`;
        }
      }

      // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
      document.getElementById("btn-chord").classList.toggle("active", chordMode);
      document.getElementById("btn-tie").classList.toggle("active", tieMode);
      document.getElementById("btn-slur").classList.toggle("active", slurMode);
      document.getElementById("btn-select").classList.toggle("active", selectMode);
      document.getElementById("btn-dot").classList.toggle("active", isDotted);
      document.getElementById("btn-triplet").classList.toggle("active", isTriplet);
      document.getElementById("btn-rest").classList.toggle("active", isRest);
    }

    function updateModeIndicator() {
      const indicator = document.getElementById("mode-indicator");
      if (slurMode && slurStartIndex >= 0) {
        indicator.textContent = "ã‚¹ãƒ©ãƒ¼çµ‚ç‚¹ã‚’é¸æŠ";
        indicator.classList.add("visible");
      } else if (slurMode) {
        indicator.textContent = "ã‚¹ãƒ©ãƒ¼å§‹ç‚¹ã‚’é¸æŠ";
        indicator.classList.add("visible");
      } else if (tieMode) {
        indicator.textContent = "ã‚¿ã‚¤ãƒ¢ãƒ¼ãƒ‰";
        indicator.classList.add("visible");
      } else if (selectMode) {
        indicator.textContent = "é¸æŠãƒ¢ãƒ¼ãƒ‰";
        indicator.classList.add("visible");
      } else if (chordMode) {
        indicator.textContent = "å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰";
        indicator.classList.add("visible");
      } else {
        indicator.classList.remove("visible");
      }
    }

    function addEventOrChord() {
      if (selectMode) {
        // é¸æŠãƒ¢ãƒ¼ãƒ‰ã§ã¯éŸ³ç¬¦è¿½åŠ ã—ãªã„
        return;
      }

      if (slurMode && events.length > 0 && slurStartIndex < 0) {
        // ã‚¹ãƒ©ãƒ¼é–‹å§‹ä½ç½®ã‚’è¨­å®š
        slurStartIndex = events.length - 1;
        events[slurStartIndex].slurStart = true;
        updateModeIndicator();
        return;
      }

      if (slurMode && slurStartIndex >= 0) {
        // ã‚¹ãƒ©ãƒ¼çµ‚äº†ä½ç½®ã‚’è¨­å®š
        saveHistory();
        events[events.length - 1].slurEnd = true;
        slurStartIndex = -1;
        slurMode = false;
        renderScore();
        return;
      }

      if (chordMode && events.length > 0 && !events[events.length - 1].isRest) {
        // å’ŒéŸ³è¿½åŠ ï¼ˆä¼‘ç¬¦ã«ã¯å’ŒéŸ³ã‚’è¿½åŠ ã—ãªã„ï¼‰
        saveHistory();
        const lastEv = events[events.length - 1];
        lastEv.chords.push({
          step: currentStep,
          alter: getAccAlterFromCurrent(),
          octave: currentOctave
        });
        selectedEventIndex = events.length - 1;
        renderScore();
      } else {
        // æ–°è¦éŸ³ç¬¦/ä¼‘ç¬¦è¿½åŠ 
        saveHistory();
        const newEvent = {
          durationType: currentDuration,
          isDotted: isDotted,
          isTriplet: isTriplet,
          isRest: isRest,
          chords: isRest ? [] : [{
            step: currentStep,
            alter: getAccAlterFromCurrent(),
            octave: currentOctave
          }],
          tied: tieMode && events.length > 0 && !isRest,
          slurStart: false,
          slurEnd: false,
          staccato: false,
          accent: false
        };
        events.push(newEvent);
        selectedEventIndex = events.length - 1;
        renderScore();
      }
    }

    function deleteSelected() {
      if (selectedEventIndex >= 0 && selectedEventIndex < events.length) {
        saveHistory();
        events.splice(selectedEventIndex, 1);
        selectedEventIndex = Math.min(selectedEventIndex, events.length - 1);
        renderScore();
      }
    }

    function clearAll() {
      if (events.length > 0 && confirm("ã™ã¹ã¦ã®éŸ³ç¬¦ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        saveHistory();
        events = [];
        selectedEventIndex = -1;
        renderScore();
      }
    }

    function changeOctave(delta) {
      let newOct = currentOctave + delta;
      if (newOct < 1) newOct = 1;
      if (newOct > 7) newOct = 7;
      currentOctave = newOct;
      document.querySelectorAll(".octave-btn").forEach(btn => {
        btn.classList.toggle("active", parseInt(btn.dataset.oct, 10) === currentOctave);
      });
      updateStatus();
    }

    function exportMusicXML() {
      const xml = buildMusicXML();
      const blob = new Blob([xml], { type: "application/xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, "-");
      a.download = `score_${timestamp}.xml`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function playScore() {
      if (!synth) {
        await Tone.start();
        synth = new Tone.Synth().toDestination();
      }

      const tempo = parseInt(document.getElementById("tempo").value || "120", 10);
      const beatDuration = 60 / tempo; // 1æ‹ã®ç§’æ•°

      let currentTime = 0;
      events.forEach(ev => {
        if (!ev.isRest && ev.chords.length > 0) {
          const { beats } = durationToXml(ev.durationType, ev.isDotted, ev.isTriplet);
          const duration = beats * beatDuration;
          
          ev.chords.forEach(ch => {
            const note = ch.step + (ch.alter === 1 ? "#" : ch.alter === -1 ? "b" : "") + ch.octave;
            synth.triggerAttackRelease(note, duration, `+${currentTime}`);
          });
        }

        const { beats } = durationToXml(ev.durationType, ev.isDotted, ev.isTriplet);
        currentTime += beats * beatDuration;
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("osmd-container");
      
      // OSMDåˆæœŸåŒ–
      osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(container, {
        autoResize: true,
        drawPartNames: false,
        drawMeasureNumbers: true,
        drawTitle: false,
        backend: "svg",
        drawingParameters: "compact",
        renderSingleHorizontalStaffline: false
      });

      renderScore();

      // æ¥½è­œã‚¯ãƒªãƒƒã‚¯
      container.addEventListener("click", (e) => {
        if (!selectMode) {
          addEventOrChord();
        }
      });

      // éŸ³åãƒœã‚¿ãƒ³
      document.querySelectorAll(".note-name-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".note-name-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentStep = btn.dataset.step;
          isRest = false;
          updateStatus();
        });
      });

      // ä¼‘ç¬¦ãƒœã‚¿ãƒ³
      document.getElementById("btn-rest").addEventListener("click", (e) => {
        e.stopPropagation();
        isRest = !isRest;
        updateStatus();
      });

      // #, â™­, â™®
      document.querySelectorAll(".note-acc-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".note-acc-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentAcc = btn.dataset.acc;
          updateStatus();
        });
      });

      // ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–
      document.querySelectorAll(".octave-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".octave-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentOctave = parseInt(btn.dataset.oct, 10);
          updateStatus();
        });
      });

      // éŸ³ä¾¡
      document.querySelectorAll(".duration-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".duration-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentDuration = btn.dataset.type;
          updateStatus();
        });
      });

      // ä»˜ç‚¹
      document.getElementById("btn-dot").addEventListener("click", (e) => {
        e.stopPropagation();
        isDotted = !isDotted;
        updateStatus();
      });

      // 3é€£ç¬¦
      document.getElementById("btn-triplet").addEventListener("click", (e) => {
        e.stopPropagation();
        isTriplet = !isTriplet;
        updateStatus();
      });

      // å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰
      document.getElementById("btn-chord").addEventListener("click", (e) => {
        e.stopPropagation();
        chordMode = !chordMode;
        tieMode = false;
        slurMode = false;
        selectMode = false;
        slurStartIndex = -1;
        updateStatus();
      });

      // ã‚¿ã‚¤ãƒ¢ãƒ¼ãƒ‰
      document.getElementById("btn-tie").addEventListener("click", (e) => {
        e.stopPropagation();
        tieMode = !tieMode;
        chordMode = false;
        slurMode = false;
        selectMode = false;
        slurStartIndex = -1;
        updateStatus();
      });

      // ã‚¹ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰
      document.getElementById("btn-slur").addEventListener("click", (e) => {
        e.stopPropagation();
        slurMode = !slurMode;
        chordMode = false;
        tieMode = false;
        selectMode = false;
        if (!slurMode) slurStartIndex = -1;
        updateStatus();
      });

      // é¸æŠãƒ¢ãƒ¼ãƒ‰
      document.getElementById("btn-select").addEventListener("click", (e) => {
        e.stopPropagation();
        selectMode = !selectMode;
        chordMode = false;
        tieMode = false;
        slurMode = false;
        slurStartIndex = -1;
        updateStatus();
      });

      // ã‚¹ã‚¿ãƒƒã‚«ãƒ¼ãƒˆ
      document.getElementById("btn-staccato").addEventListener("click", (e) => {
        e.stopPropagation();
        if (selectedEventIndex >= 0 && selectedEventIndex < events.length) {
          saveHistory();
          events[selectedEventIndex].staccato = !events[selectedEventIndex].staccato;
          events[selectedEventIndex].accent = false; // ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã¨æ’ä»–
          renderScore();
        }
      });

      // ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
      document.getElementById("btn-accent").addEventListener("click", (e) => {
        e.stopPropagation();
        if (selectedEventIndex >= 0 && selectedEventIndex < events.length) {
          saveHistory();
          events[selectedEventIndex].accent = !events[selectedEventIndex].accent;
          events[selectedEventIndex].staccato = false; // ã‚¹ã‚¿ãƒƒã‚«ãƒ¼ãƒˆã¨æ’ä»–
          renderScore();
        }
      });

      // å‰Šé™¤ãƒ»Undoãƒ»å…¨æ¶ˆå»
      document.getElementById("btn-delete").addEventListener("click", (e) => {
        e.stopPropagation();
        deleteSelected();
      });

      document.getElementById("btn-undo").addEventListener("click", (e) => {
        e.stopPropagation();
        restoreHistory();
      });

      document.getElementById("btn-clear").addEventListener("click", (e) => {
        e.stopPropagation();
        clearAll();
      });

      // ãƒˆéŸ³/ãƒ˜éŸ³
      const trebleBtn = document.getElementById("clef-treble");
      const bassBtn = document.getElementById("clef-bass");
      trebleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        trebleBtn.classList.add("active");
        bassBtn.classList.remove("active");
        renderScore();
      });
      bassBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        bassBtn.classList.add("active");
        trebleBtn.classList.remove("active");
        renderScore();
      });

      // æ‹å­ãƒ»èª¿ãƒ»ãƒ†ãƒ³ãƒå¤‰æ›´
      document.getElementById("time-signature").addEventListener("change", renderScore);
      document.getElementById("key-signature").addEventListener("change", renderScore);
      document.getElementById("tempo").addEventListener("change", renderScore);

      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      document.getElementById("btn-export").addEventListener("click", (e) => {
        e.stopPropagation();
        exportMusicXML();
      });

      // å†ç”Ÿ
      document.getElementById("btn-play").addEventListener("click", (e) => {
        e.stopPropagation();
        playScore();
      });

      updateStatus();
    });
  </script>
</body>
</html>
